{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Chat with {% if messages %}{{ messages[0].receiver.username if user.id ==
                        messages[0].sender.id else messages[0].sender.username }}{% endif %}</h5>
                </div>

                <div class="card-body message-container" style="height: 400px; overflow-y: auto;">
                    {% for message in messages %}
                    <div class="mb-3 {% if message.sender.id == user.id %}text-end{% endif %}">
                        <div class="d-flex {% if message.sender.id == user.id %}justify-content-end{% else %}justify-content-start{% endif %}">
                            <div class="message-bubble {% if message.sender.id == user.id %}bg-primary text-white{% else %}bg-light{% endif %} p-3 rounded">
                                <div class="message-content">{{ message.content }}</div>
                                <div class="message-meta small mt-1 {% if message.sender.id == user.id %}text-white-50{% else %}text-muted{% endif %}">
                                    {{ message.created_at.strftime('%H:%M, %d %b') }}
                                    {% if message.sender.id == user.id %}
                                    <span class="read-status">
                                                {% if message.is_read %}<i class="fas fa-check-double"></i>{% else %}<i
                                            class="fas fa-check"></i>{% endif %}
                                            </span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <div class="card-footer">
                    <form id="message-form" class="d-flex">
                        <input type="hidden" id="receiver_id" value="{{ receiver_id }}">
                        <input type="text"
                               id="message-input"
                               class="form-control me-2"
                               placeholder="Type your message..."
                               required
                               autocomplete="off">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-paper-plane"></i> Send
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/socket.io-client@4.7.2/dist/socket.io.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const messageContainer = document.querySelector('.message-container');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        const receiverId = document.getElementById('receiver_id').value;

        // Scroll to bottom of messages
        messageContainer.scrollTop = messageContainer.scrollHeight;

        // Connect to Socket.IO
        const socket = io();

        // Join the room for these two users
        socket.on('connect', function() {
            const roomName = getRoomName({{ user.id }}, receiverId);
            socket.emit('join_room', roomName);
        });

        // Handle incoming messages
        socket.on('new_message', function(data) {
            const isSender = data.sender_id == {{ user.id }};
            const messageHtml = `
                <div class="mb-3 ${isSender ? 'text-end' : ''}">
                    <div class="d-flex ${isSender ? 'justify-content-end' : 'justify-content-start'}">
                        <div class="message-bubble ${isSender ? 'bg-primary text-white' : 'bg-light'} p-3 rounded">
                            <div class="message-content">${data.content}</div>
                            <div class="message-meta small mt-1 ${isSender ? 'text-white-50' : 'text-muted'}">
                                ${new Date(data.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})},
                                ${new Date(data.created_at).toLocaleDateString([], {day: 'numeric', month: 'short'})}
                                ${isSender ?
                                    `<span class="read-status">
                                        ${data.is_read ? '<i class="fas fa-check-double"></i>' : '<i class="fas fa-check"></i>'}
                                    </span>` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;

            messageContainer.insertAdjacentHTML('beforeend', messageHtml);
            messageContainer.scrollTop = messageContainer.scrollHeight;

            // Mark as read if this is a received message
            if (!isSender) {
                markAsRead(data.id);
            }
        });

        // Handle message read status updates
        socket.on('message_read', function(messageId) {
            const readStatus = document.querySelector(`.read-status[data-message-id="${messageId}"]`);
            if (readStatus) {
                readStatus.innerHTML = '<i class="fas fa-check-double"></i>';
            }
        });

        // Send message
        messageForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const content = messageInput.value.trim();
            if (content) {
                fetch(`/messages/${receiverId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                        // Удалить строку с CSRF
                    },
                    body: JSON.stringify({ content: content })
                })
                .then(response => response.json())
                .then(data => {
                    messageInput.value = '';
                })
                .catch(error => console.error('Error:', error));
            }
        });

        // Generate consistent room name for two users
        function getRoomName(userId1, userId2) {
            const ids = [parseInt(userId1), parseInt(userId2)].sort();
            return `chat_${ids[0]}_${ids[1]}`;
        }

        // Mark message as read
        function markAsRead(messageId) {
            fetch(`/messages/${messageId}/read`, {
                method: 'POST',
                headers: {

                }
            });
        }

        // Mark all messages as read when page loads
        function markAllAsRead() {
            fetch(`/messages/${receiverId}/read_all`, {
                method: 'POST',
                headers: {

                }
            });
        }

        // Call markAllAsRead when page loads
        markAllAsRead();

        // Auto-focus message input
        messageInput.focus();
    });
</script>

<style>
    .message-bubble {
        max-width: 70%;
        word-wrap: break-word;
    }

    .message-container {
        scroll-behavior: smooth;
    }

    /* Custom scrollbar */
    .message-container::-webkit-scrollbar {
        width: 8px;
    }

    .message-container::-webkit-scrollbar-track {
        background: #f1f1f1;
    }

    .message-container::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 4px;
    }

    .message-container::-webkit-scrollbar-thumb:hover {
        background: #555;
    }
</style>
{% endblock %}